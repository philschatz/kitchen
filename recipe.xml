<!-- ***************************************
     
# Example Recipe

This recipe does the following:

- numbers the chapter and each section
- moves the exercises to the end of the chapter
- moves the answers to the end of the book
- numbers each exercise and answer
- links the answers and exercises to each other
    - the exercise DOES NOT contain the chapter number
    - the answer DOES contain the chapter number
- numbers figures
- groups exercises by which section they came from
    - each title links back to the section
- wraps the note title in a span
- wraps all the non-title children of a note in an element

*************************************** -->
<r:root 
    xmlns:r="urn:replacer-xml"
    xmlns="http://www.w3.org/1999/xhtml"
    xmlns:h="http://www.w3.org/1999/xhtml"
    >

    <r:replace selector="h:body">
        <r:declare>
            <r:bucket name="solutionBucket"/>
            <r:counter name="chapterCounter" selector="*[@data-type='chapter']"/>
        </r:declare>

        <r:this>
            <r:children/>
            <section>
                <h1>Answers</h1>
                <r:dump-bucket name="solutionBucket"/>
            </section>

            <!-- <r:index/> -->
        </r:this>

        <!--Chapter-->
        <r:replace selector="*[@data-type='chapter']">
            <r:declare>
                <r:bucket name="exerciseBucket"/>
                <r:counter name="sectionCounter" selector="*[@data-type='page']"/>
                <r:counter name="exerciseCounter" selector="*[@data-type='exercise']"/>
                <r:counter name="figureCounter" selector="h:figure"/>
            </r:declare>

            <r:this>
                <h2>Chapter <r:dump-counter name="chapterCounter"/></h2>
                <r:children/>
                <div>
                    <h2>Homework</h2>
                    <r:dump-bucket name="exerciseBucket" group-by="*[@data-type='page']" group-by-title="./*[@data-type='document-title']"/>
                </div>
            </r:this>

            <!--Exercise-->
            <r:replace move-to="exerciseBucket" selector="*[@data-type='exercise']">
                <r:declare>
                    <r:link-text>
                        <r:dump-counter name="chapterCounter"/>.<r:dump-counter name="exerciseCounter"/>
                    </r:link-text>
                </r:declare>
                
                <r:this>
                    <r:link to="child" selector="*[@data-type='solution']"><r:dump-counter name="exerciseCounter"/></r:link>
                    <r:children/>
                </r:this>

                <!--Solution-->
                <r:replace move-to="solutionBucket" selector="*[@data-type='solution']">
                    <r:this>
                        <r:link to="parent"/>
                        <r:children/>
                    </r:this>
                </r:replace>

            </r:replace>

            <!--Figure-->
            <r:replace selector="h:figure">

                <r:this>
                    <r:children/>
                </r:this>

                <!--Caption-->
                <r:replace selector="h:figcaption">
                    <r:this>
                        <strong>
                            <r:dump-counter name="chapterCounter"/>.<r:dump-counter name="figureCounter"/>
                        </strong>
                        <r:children/>
                    </r:this>
                </r:replace>

            </r:replace>

            <!--Note-->
            <r:replace selector="*[@data-type='note']">

                <r:this h:class="os-note">
                    <r:children selector="*[@data-type='title']"/>
                    <h:div class="os-note-body">
                        <r:children selector="*[not(@data-type='title')]"/>
                    </h:div>
                </r:this>

                <r:replace selector="*[@data-type='title']">
                    <h:h6 data-type="title" class="os-note-title">
                        <r:children/>
                    </h:h6>
                </r:replace>
            </r:replace>

            <!--Section-->
            <r:replace selector="*[@data-type='page']">
                <r:declare>
                    <r:link-text>
                        <!--TODO: Maybe copy-content should somehow squirrel away the original content instead of the expanded content-->
                        <!-- <r:dump-counter name="chapterCounter"/>.<r:dump-counter name="sectionCounter"/>:  -->
                        <r:copy-content selector="./*[@data-type='document-title']/node()"/>
                    </r:link-text>
                </r:declare>
                
                <r:this>
                    <r:children/>
                </r:this>

                <!-- Add the section number to the title -->
                <r:replace selector="*[@data-type='document-title']">
                    <r:this>
                        <r:dump-counter name="chapterCounter"/>.<r:dump-counter name="sectionCounter"/>: <r:children/>
                    </r:this>
                </r:replace>
            </r:replace>

        </r:replace>

    </r:replace>
</r:root>
